{% extends "base.html" %} {% block title %}Admin Dashboard{% endblock %} {%
block styles %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/admin_dashboard.css') }}"
/>
{% endblock %} {% block content %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/admin_dashboard.css') }}"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div class="admin-container">
      <h1 class="dashboard-title">Admin Dashboard</h1>

      <!-- Roadmaps Section -->
      <!-- Roadmaps Section -->
      <div class="dashboard-section">
        <h3 class="section-title">Roadmaps</h3>
        <div id="roadmap-section">
          {% for roadmap in roadmaps %}
          <div class="roadmap-card">
            <div class="roadmap-header">
              <button
                class="toggle-button gradient-button"
                onclick="toggleVisibility('roadmap-{{ loop.index }}')"
              >
                {{ roadmap.title }}
              </button>
              <span class="roadmap-description"
                >&#8594; {{ roadmap.description }}</span
              >
            </div>
            <div class="action-buttons">
              <a
                href="{{ url_for('admin_edit_roadmap', roadmap_id=roadmap.roadmap_id) }}"
                class="edit-button secondary-button"
              >
                Edit Roadmap
              </a>
            </div>
            <div
              id="roadmap-{{ loop.index }}"
              class="collapsible-content"
              style="display: none"
            >
              <ul class="course-list">
                {% for course in roadmap.courses %}
                <li class="course-item">
                  <div class="course-header">
                    <strong>{{ course.name }}</strong>
                    <p class="course-description">{{ course.description }}</p>
                    <div class="action-buttons">
                      <button
                        class="toggle-button secondary-button"
                        onclick="toggleVisibility('course-{{ course.name}}')"
                      >
                        View Chapters
                      </button>
                      <a
                        href="{{ url_for('admin_edit_course', roadmap_id=roadmap.roadmap_id, course_id=course.course_id) }}"
                        class="edit-button secondary-button"
                      >
                        Edit Course
                      </a>
                    </div>
                  </div>
                  <ul id="course-{{course.name}}" class="chapter-list collapsible-content" style="display: none;">
                    {% for chapter in course.chapters %}
                    <li class="chapter-item">
                        <div class="chapter-item-header">
                            <span class="chapter-item-title">{{ chapter.title }}</span>
                            <div class="chapter-item-actions">
                                {% if chapter.link %}
                                <a href="{% if '://' in chapter.link %}{{ chapter.link }}{% else %}https://{{ chapter.link }}{% endif %}" 
                                   target="_blank" 
                                   rel="noopener noreferrer" 
                                   class="chapter-item-reference">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                                    </svg>
                                    Reference
                                </a>
                                {% endif %}
                                <a href="{{ url_for('create_quiz', roadmap_id=roadmap.roadmap_id, course_id=course.course_id, chapter_title=chapter.title) }}" 
                                   class="btn btn-sm btn-secondary">
                                    Create Quiz</a>
                    </li>
                    {% endfor %}
                  </ul>
                </li>
                {% endfor %}
              </ul>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Students Section -->
      <div class="dashboard-section">
        <h3 class="section-title">Sort and Filter Students</h3>
        <form id="sorting-form" class="control-panel">
          <div id="sort-criteria-container" class="sort-section">
            <label class="control-label">Sort by:</label>
            <button
              type="button"
              class="gradient-button"
              onclick="addSortCriteria()"
            >
              Add Criteria
            </button>
          </div>

          <div id="filter-columns-container" class="filter-section">
            <label class="control-label">Filter Columns:</label>
            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" id="filter-name" checked /> Name
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="filter-email" checked /> Email
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="filter-cgpa" checked /> CGPA
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="filter-gvishwanthan" checked />
                GVishwanthan Challenge
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="filter-dsa" checked /> DSA Completion
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="filter-cloud" checked /> Cloud
                Computing
              </label>
            </div>
          </div>

          <div class="filter-top-section">
            <label class="control-label">Top Candidates:</label>
            <input
              type="number"
              id="top-candidates-number"
              placeholder="Enter number"
              min="1"
            />
            <button
              type="button"
              id="filter-top-button"
              class="gradient-button"
            >
              Filter Top Candidates
            </button>
          </div>

          <div class="action-buttons">
            <button type="button" id="apply-button" class="gradient-button">
              Apply
            </button>
            <button
              type="button"
              id="export-csv-button"
              class="gradient-button"
            >
              Export to CSV
            </button>
          </div>
        </form>

        <div class="chart-container">
          <canvas id="performanceChart"></canvas>
        </div>

        <div class="table-container">
          <table id="students-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>CGPA</th>
                <th>GVishwanthan Challenge</th>
                <th>DSA Completion</th>
                <th>Cloud Computing</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Student1</td>
                <td>student1@gmail.com</td>
                <td>9.0</td>
                <td>3%</td>
                <td>100%</td>
                <td>0%</td>
              </tr>
              <tr>
                <td>Student2</td>
                <td>student2@gmail.com</td>
                <td>8.7</td>
                <td>0%</td>
                <td>40%</td>
                <td>0%</td>
              </tr>
              <tr>
                <td>Akhand</td>
                <td>student3@gmail.com</td>
                <td>8.5</td>
                <td>0%</td>
                <td>0%</td>
                <td>30%</td>
              </tr>
              <tr>
                <td>Aastha</td>
                <td>student4@gmail.com</td>
                <td>9.7</td>
                <td>0%</td>
                <td>80%</td>
                <td>40%</td>
              </tr>
              <tr>
                <td>Hitesh</td>
                <td>student5@gmail.com</td>
                <td>9.6</td>
                <td>0%</td>
                <td>0%</td>
                <td>30.7%</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      // Roadmap Toggle Functionality
      function toggleVisibility(id) {
        const element = document.getElementById(id);
        if (element.style.display === "none" || element.style.display === "") {
          element.style.display = "block";
        } else {
          element.style.display = "none";
        }
      }

      // Performance Chart
      const ctx = document.getElementById("performanceChart").getContext("2d");
      const performanceChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["Student1", "Student2", "Akhand", "Aastha", "Hitesh"],
          datasets: [
            {
              label: "GVishwanthan Challenge",
              data: [3, 0, 0, 0, 0],
              backgroundColor: "rgba(75, 192, 192, 0.6)",
            },
            {
              label: "DSA Completion",
              data: [100, 40, 0, 80, 0],
              backgroundColor: "rgba(255, 99, 132, 0.6)",
            },
            {
              label: "Cloud Computing",
              data: [0, 0, 30, 40, 30.7],
              backgroundColor: "rgba(54, 162, 235, 0.6)",
            },
          ],
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
            },
          },
          plugins: {
            title: {
              display: true,
              text: "Student Performance Across Roadmaps",
            },
          },
        },
      });

      // Students Data
      const students = [
        {
          name: "Student1",
          email: "student1@gmail.com",
          cgpa: 9.0,
          gvishwanthan: 3,
          dsa: 100,
          cloud: 0,
        },
        {
          name: "Student2",
          email: "student2@gmail.com",
          cgpa: 8.7,
          gvishwanthan: 0,
          dsa: 40,
          cloud: 0,
        },
        {
          name: "Akhand",
          email: "student3@gmail.com",
          cgpa: 8.5,
          gvishwanthan: 0,
          dsa: 50,
          cloud: 30,
        },
        {
          name: "Aastha",
          email: "student4@gmail.com",
          cgpa: 9.7,
          gvishwanthan: 0,
          dsa: 80,
          cloud: 40,
        },
        {
          name: "Hitesh",
          email: "student5@gmail.com",
          cgpa: 9.6,
          gvishwanthan: 0,
          dsa: 0,
          cloud: 30.7,
        },
      ];

      // Sorting Criteria Functions
      function addSortCriteria() {
        const container = document.getElementById("sort-criteria-container");
        const div = document.createElement("div");
        div.className = "sort-criteria-item";
        div.innerHTML = `
                <select class="sort-criteria">
                    <option value="name-asc">Name (Ascending)</option>
                    <option value="name-desc">Name (Descending)</option>
                    <option value="cgpa-asc">CGPA (Ascending)</option>
                    <option value="cgpa-desc">CGPA (Descending)</option>
                    <option value="gvishwanthan-asc">GVishwanthan (Ascending)</option>
                    <option value="gvishwanthan-desc">GVishwanthan (Descending)</option>
                    <option value="dsa-asc">DSA Completion (Ascending)</option>
                    <option value="dsa-desc">DSA Completion (Descending)</option>
                    <option value="cloud-asc">Cloud Computing (Ascending)</option>
                    <option value="cloud-desc">Cloud Computing (Descending)</option>
                </select>
                <button type="button" onclick="removeSortCriteria(this)">Remove</button>
            `;
        container.appendChild(div);
      }

      function removeSortCriteria(button) {
        button.parentElement.remove();
      }

      function dynamicSort(criteria) {
        return function (a, b) {
          for (let criterion of criteria) {
            let order = "asc";
            let key = criterion;

            if (criterion.endsWith("-desc")) {
              order = "desc";
              key = criterion.slice(0, -5);
            } else if (criterion.endsWith("-asc")) {
              key = criterion.slice(0, -4);
            }

            const aValue = a[key];
            const bValue = b[key];

            if (aValue < bValue) return order === "asc" ? -1 : 1;
            if (aValue > bValue) return order === "asc" ? 1 : -1;
          }
          return 0;
        };
      }

      function sortAndDisplayStudents() {
        const sortCriteria = Array.from(
          document.querySelectorAll(".sort-criteria")
        ).map((select) => select.value);
        const sortedStudents = [...students].sort(dynamicSort(sortCriteria));
        displayStudents(sortedStudents);
      }

      function displayStudents(data) {
        const tableBody = document.querySelector("#students-table tbody");
        tableBody.innerHTML = "";

        data.forEach((student) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>${student.name}</td>
                    <td>${student.email}</td>
                    <td>${student.cgpa}</td>
                    <td>${student.gvishwanthan}%</td>
                    <td>${student.dsa}%</td>
                    <td>${student.cloud}%</td>
                `;
          tableBody.appendChild(row);
        });

        updateChart(data);
        applyColumnFilters();
      }

      function updateChart(data) {
        performanceChart.data.labels = data.map((student) => student.name);
        performanceChart.data.datasets[0].data = data.map(
          (student) => student.gvishwanthan
        );
        performanceChart.data.datasets[1].data = data.map(
          (student) => student.dsa
        );
        performanceChart.data.datasets[2].data = data.map(
          (student) => student.cloud
        );
        performanceChart.update();
      }

      function applyColumnFilters() {
    const table = document.getElementById('students-table');
    const headers = table.querySelectorAll('thead th');
    const rows = table.querySelectorAll('tbody tr');

    headers.forEach((header, index) => {
        const columnClass = header.textContent.toLowerCase().replace(/\s+/g, '');
        const checkbox = document.getElementById(`filter-${columnClass}`);
        
        if (checkbox && !checkbox.checked) {
            // Hide header column
            header.style.display = 'none';
            
            // Hide corresponding data columns in all rows
            rows.forEach(row => {
                row.cells[index].style.display = 'none';
            });
        } else {
            // Show header column
            header.style.display = '';
            
            // Show corresponding data columns in all rows
            rows.forEach(row => {
                row.cells[index].style.display = '';
            });
        }
    });
}

      function filterTopCandidates() {
        const topNumber = parseInt(
          document.getElementById("top-candidates-number").value
        );
        if (isNaN(topNumber) || topNumber <= 0) {
          alert("Please enter a valid number of top candidates.");
          return;
        }
        const sortedStudents = [...students]
          .sort(dynamicSort(["cgpa-desc"]))
          .slice(0, topNumber);
        displayStudents(sortedStudents);
      }

      function exportToCSV() {
        const rows = [
          ["Name", "Email", "CGPA", "GVishwanthan", "DSA", "Cloud Computing"],
        ];

        const tableRows = document.querySelectorAll("#students-table tbody tr");
        tableRows.forEach((row) => {
          const cells = row.querySelectorAll("td");
          const rowData = Array.from(cells).map((cell) => cell.textContent);
          rows.push(rowData);
        });

        let csvContent =
          "data:text/csv;charset=utf-8," +
          rows.map((e) => e.join(",")).join("\n");

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "students_data.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // Event Listeners
      document
        .getElementById("apply-button")
        .addEventListener("click", sortAndDisplayStudents);
      document
        .getElementById("filter-top-button")
        .addEventListener("click", filterTopCandidates);
      document
        .getElementById("export-csv-button")
        .addEventListener("click", exportToCSV);

      // Initial Display
      displayStudents(students);
    </script>
  </body>
</html>

{% endblock %}
